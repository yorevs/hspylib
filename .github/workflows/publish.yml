name: publish
run-name: HSPyLib publish - ${{github.run_number}} [@${{ github.actor }}]

on:
  workflow_dispatch:
    inputs:
      gradle_debug_params:
        description: 'Gradle debug parameters'
        default: ''
        required: false
        type: string
      comment:
        description: 'Publish description'
        default: 'New HSPyLib '
        required: false
        type: string
      release_type:
        description: 'Major/Minor or Patch only update ?'
        type: choice
        required: true
        default: 'patch'
        options:
          - 'patch'
          - 'minor'
          - 'major'

permissions:
  contents: write

jobs:
  publish:
    runs-on: ubuntu-latest
    env:
      VERSION: ''
    steps:
    - uses: actions/checkout@v3
    - uses: actions/setup-java@v3
      with:
        distribution: temurin
        java-version: ${{ vars.JAVA_VERSION }}
    - uses: gradle/gradle-build-action@v2
      with:
        gradle-version: ${{ vars.GRADLE_VERSION }}
    - uses: actions/setup-python@v3
      with:
        python-version: ${{ vars.PYTHON_VERSION }}
    - name: Install Python tools
      run: ./gradlew installBuildTools ${gradle_debug_params}

    - name: Fetch revision details
      run: |
        git fetch --prune --unshallow
        echo "Publishing new HSPyLib revision"
        echo "New HSPyLib Revision: ${{ inputs.comment }}" > '.changelog.txt'
        echo "Changelog: " >> '.changelog.txt'
        echo "------------------------------------------------------------" >> '.changelog.txt'
        ./gradlew changelog ${gradle_debug_params} | grep -E "^'[0-9a-z]{7}" | sed -r "s/^'|'$/  /g" >> '.changelog.txt'

    - name: Create changelog file
      run: |
        cat '.changelog.txt'
        git config --global user.name "$(git log -n 1 --pretty=format:%an)"
        git config --global user.email "$(git log -n 1 --pretty=format:%ae)"
        git add '.changelog.txt'

    - name: Publish
      run: |
        bumpver update "--${{ inputs.release_type }}"
        version="$(awk '/./{line=$0} END{print line}' .version)"
        echo "VERSION=$version" >> $GITHUB_ENV
        git commit -a -m "[@${{ github.actor }}] ${{ inputs.comment }}"
        git pull --rebase -Xtheirs && git push --atomic origin HEAD

    - name: Tag revision
      run: |
        git tag -a "v${{ env.VERSION }}" -m "[@${{ github.actor }}] New HSPyLib revision v${{ env.VERSION }}"
        git push --atomic origin "v${{ env.VERSION }}"
